import { useState } from "react"
import { motion } from "framer-motion"
import { SidebarProvider, SidebarTrigger } from "@/components/ui/sidebar"
import { CerberusSidebar } from "@/components/CerberusSidebar"
import { StarfieldBackground } from "@/components/StarfieldBackground"
import { ToolDetailLayout, ToolSection, ResultsPanel } from "@/components/ToolDetailLayout"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select"
import { Badge } from "@/components/ui/badge"
import { Progress } from "@/components/ui/progress"
import { Checkbox } from "@/components/ui/checkbox"
import { useCerberusStore } from "@/store/cerberus-store"
import { Shield, AlertTriangle, Bug, Activity, Settings, ExternalLink } from "lucide-react"
import { Button } from "@/components/ui/button"

export default function VulnerabilityScannerTool() {
  const { addLog } = useCerberusStore()
  const [target, setTarget] = useState("")
  const [scanDepth, setScanDepth] = useState("medium")
  const [isScanning, setIsScanning] = useState(false)
  const [progress, setProgress] = useState(0)
  const [results, setResults] = useState<any[]>([])
  const [scanModules, setScanModules] = useState({
    xss: true,
    sqli: true,
    csrf: true,
    lfi: true,
    rce: true,
    xxe: false
  })

  const mockVulnerabilities = [
    {
      id: "CVE-2024-0001",
      title: "SQL Injection in Login Form",
      severity: "Critical",
      cvss: 9.8,
      description: "SQL injection vulnerability allows attacker to bypass authentication",
      affected: "/login.php",
      solution: "Use prepared statements and parameterized queries",
      references: ["https://nvd.nist.gov/vuln/detail/CVE-2024-0001"]
    },
    {
      id: "CVE-2024-0002",
      title: "Cross-Site Scripting (XSS) - Reflected",
      severity: "High",
      cvss: 7.4,
      description: "Reflected XSS in search parameter allows code injection",
      affected: "/search?q=",
      solution: "Sanitize and escape user input before rendering",
      references: ["https://owasp.org/www-community/attacks/xss/"]
    },
    {
      id: "CUSTOM-001",
      title: "Weak Password Policy",
      severity: "Medium",
      cvss: 5.3,
      description: "Password policy allows weak passwords (min 6 chars, no complexity)",
      affected: "/register",
      solution: "Implement strong password requirements",
      references: []
    },
    {
      id: "INFO-001",
      title: "Directory Listing Enabled",
      severity: "Low",
      cvss: 3.1,
      description: "Server exposes directory contents at /uploads/",
      affected: "/uploads/",
      solution: "Disable directory listing in web server configuration",
      references: []
    },
    {
      id: "CVE-2024-0003",
      title: "CSRF Token Missing",
      severity: "High",
      cvss: 6.5,
      description: "State-changing operations lack CSRF protection",
      affected: "/profile/update",
      solution: "Implement CSRF tokens for all state-changing requests",
      references: ["https://owasp.org/www-community/attacks/csrf"]
    }
  ]

  const executeScan = async () => {
    if (!target.trim()) {
      addLog({ level: 'warning', source: 'Vuln Scanner', message: 'Digite um alvo válido' })
      return
    }

    setIsScanning(true)
    setProgress(0)
    setResults([])

    addLog({
      level: 'info',
      source: 'Vuln Scanner',
      message: `Iniciando scan de vulnerabilidades em ${target}`
    })

    // Simulate scan progress
    for (let i = 0; i <= 100; i += 5) {
      await new Promise(resolve => setTimeout(resolve, 200))
      setProgress(i)
    }

    setResults(mockVulnerabilities)
    setIsScanning(false)

    const critical = mockVulnerabilities.filter(v => v.severity === 'Critical').length
    const high = mockVulnerabilities.filter(v => v.severity === 'High').length

    addLog({
      level: critical > 0 ? 'error' : high > 0 ? 'warning' : 'success',
      source: 'Vuln Scanner',
      message: `Scan concluído: ${mockVulnerabilities.length} vulnerabilidades encontradas`
    })
  }

  const exportResults = () => {
    const dataStr = JSON.stringify(results, null, 2)
    const blob = new Blob([dataStr], { type: 'application/json' })
    const url = URL.createObjectURL(blob)
    const link = document.createElement('a')
    link.href = url
    link.download = `vulnerability_scan_${Date.now()}.json`
    link.click()

    addLog({ level: 'info', source: 'Vuln Scanner', message: 'Resultados exportados' })
  }

  const getSeverityColor = (severity: string) => {
    switch (severity) {
      case 'Critical': return 'bg-red-900/50 text-red-400 border-red-800'
      case 'High': return 'bg-orange-900/50 text-orange-400 border-orange-800'
      case 'Medium': return 'bg-yellow-900/50 text-yellow-400 border-yellow-800'
      case 'Low': return 'bg-blue-900/50 text-blue-400 border-blue-800'
      default: return 'bg-muted text-muted-foreground'
    }
  }

  const getCVSSColor = (cvss: number) => {
    if (cvss >= 9.0) return 'text-red-400'
    if (cvss >= 7.0) return 'text-orange-400'
    if (cvss >= 4.0) return 'text-yellow-400'
    return 'text-blue-400'
  }

  return (
    <div className="min-h-screen bg-background relative">
      <StarfieldBackground />
      <SidebarProvider>
        <div className="flex w-full min-h-screen">
          <CerberusSidebar />
          
          <div className="flex-1 flex flex-col relative z-10">
            <header className="h-16 border-b border-foreground/10 bg-background/80 backdrop-blur-xl flex items-center px-6">
              <SidebarTrigger className="mr-4" />
            </header>

            <main className="flex-1 p-6">
              <ToolDetailLayout
                title="Vulnerability Scanner"
                description="Escaneie aplicações web em busca de vulnerabilidades conhecidas como SQL Injection, XSS, CSRF e outras falhas de segurança."
                icon={<Bug className="h-6 w-6 text-primary" />}
                category="Security Assessment"
                difficulty="Medium"
                onExecute={executeScan}
                onExport={results.length > 0 ? exportResults : undefined}
                isExecuting={isScanning}
                hasResults={results.length > 0}
              >
                {/* Configuration */}
                <ToolSection title="Configuração" icon={<Settings className="h-5 w-5" />}>
                  <div className="space-y-4">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div className="space-y-2">
                        <Label htmlFor="target">Alvo (URL)</Label>
                        <Input
                          id="target"
                          placeholder="https://example.com"
                          value={target}
                          onChange={(e) => setTarget(e.target.value)}
                          className="bg-terminal-bg border-glass-border"
                        />
                      </div>

                      <div className="space-y-2">
                        <Label htmlFor="scanDepth">Profundidade do Scan</Label>
                        <Select value={scanDepth} onValueChange={setScanDepth}>
                          <SelectTrigger id="scanDepth" className="bg-terminal-bg border-glass-border">
                            <SelectValue />
                          </SelectTrigger>
                          <SelectContent>
                            <SelectItem value="quick">Quick (5 min)</SelectItem>
                            <SelectItem value="medium">Medium (15 min)</SelectItem>
                            <SelectItem value="deep">Deep (45 min)</SelectItem>
                            <SelectItem value="exhaustive">Exhaustive (2+ hours)</SelectItem>
                          </SelectContent>
                        </Select>
                      </div>
                    </div>

                    <div>
                      <Label className="mb-3 block">Módulos de Scan</Label>
                      <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                        {Object.entries(scanModules).map(([key, value]) => (
                          <div key={key} className="flex items-center space-x-2">
                            <Checkbox
                              id={key}
                              checked={value}
                              onCheckedChange={(checked) => 
                                setScanModules(prev => ({ ...prev, [key]: checked as boolean }))
                              }
                            />
                            <Label htmlFor={key} className="text-sm cursor-pointer">
                              {key.toUpperCase()}
                            </Label>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                </ToolSection>

                {/* Progress */}
                {isScanning && (
                  <motion.div
                    initial={{ opacity: 0, y: 20 }}
                    animate={{ opacity: 1, y: 0 }}
                  >
                    <ToolSection title="Progresso do Scan" icon={<Activity className="h-5 w-5" />}>
                      <div className="space-y-3">
                        <Progress value={progress} className="h-2" />
                        <div className="flex justify-between text-sm">
                          <span className="text-muted-foreground">
                            Testando vulnerabilidades...
                          </span>
                          <span className="text-primary font-semibold">{progress}%</span>
                        </div>
                      </div>
                    </ToolSection>
                  </motion.div>
                )}

                {/* Results */}
                {results.length > 0 ? (
                  <ResultsPanel>
                    <div className="space-y-4">
                      {/* Summary */}
                      <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div className="p-4 bg-foreground/5 rounded-lg border border-red-900/50">
                          <p className="text-sm text-muted-foreground">Critical</p>
                          <p className="text-2xl font-bold text-red-400">
                            {results.filter(r => r.severity === 'Critical').length}
                          </p>
                        </div>
                        <div className="p-4 bg-foreground/5 rounded-lg border border-orange-900/50">
                          <p className="text-sm text-muted-foreground">High</p>
                          <p className="text-2xl font-bold text-orange-400">
                            {results.filter(r => r.severity === 'High').length}
                          </p>
                        </div>
                        <div className="p-4 bg-foreground/5 rounded-lg border border-yellow-900/50">
                          <p className="text-sm text-muted-foreground">Medium</p>
                          <p className="text-2xl font-bold text-yellow-400">
                            {results.filter(r => r.severity === 'Medium').length}
                          </p>
                        </div>
                        <div className="p-4 bg-foreground/5 rounded-lg border border-blue-900/50">
                          <p className="text-sm text-muted-foreground">Low</p>
                          <p className="text-2xl font-bold text-blue-400">
                            {results.filter(r => r.severity === 'Low').length}
                          </p>
                        </div>
                      </div>

                      {/* Vulnerability List */}
                      <div className="space-y-3">
                        {results.map((vuln, index) => (
                          <motion.div
                            key={index}
                            initial={{ opacity: 0, y: 20 }}
                            animate={{ opacity: 1, y: 0 }}
                            transition={{ delay: index * 0.05 }}
                            className="p-4 bg-foreground/5 rounded-lg border border-glass-border hover:border-primary/30 transition-all"
                          >
                            <div className="flex items-start justify-between mb-3">
                              <div className="flex-1">
                                <div className="flex items-center space-x-3 mb-2">
                                  <AlertTriangle className="h-5 w-5 text-orange-400" />
                                  <h3 className="font-semibold text-foreground">{vuln.title}</h3>
                                </div>
                                <p className="text-sm text-muted-foreground mb-2">
                                  {vuln.description}
                                </p>
                                <p className="text-xs font-mono text-muted-foreground">
                                  Affected: <span className="text-primary">{vuln.affected}</span>
                                </p>
                              </div>
                              <div className="flex flex-col items-end space-y-2">
                                <Badge className={getSeverityColor(vuln.severity)}>
                                  {vuln.severity}
                                </Badge>
                                <div className="text-right">
                                  <p className="text-xs text-muted-foreground">CVSS Score</p>
                                  <p className={`text-xl font-bold ${getCVSSColor(vuln.cvss)}`}>
                                    {vuln.cvss}
                                  </p>
                                </div>
                              </div>
                            </div>

                            <div className="p-3 bg-terminal-bg rounded border border-glass-border">
                              <p className="text-sm font-semibold text-foreground mb-1">Solution:</p>
                              <p className="text-sm text-muted-foreground">{vuln.solution}</p>
                            </div>

                            {vuln.references.length > 0 && (
                              <div className="mt-2 flex flex-wrap gap-2">
                                {vuln.references.map((ref: string, i: number) => (
                                  <Button
                                    key={i}
                                    variant="link"
                                    size="sm"
                                    className="h-auto p-0 text-xs text-primary"
                                    onClick={() => window.open(ref, '_blank')}
                                  >
                                    <ExternalLink className="h-3 w-3 mr-1" />
                                    Reference
                                  </Button>
                                ))}
                              </div>
                            )}
                          </motion.div>
                        ))}
                      </div>
                    </div>
                  </ResultsPanel>
                ) : !isScanning && (
                  <ResultsPanel isEmpty />
                )}
              </ToolDetailLayout>
            </main>
          </div>
        </div>
      </SidebarProvider>
    </div>
  )
}
